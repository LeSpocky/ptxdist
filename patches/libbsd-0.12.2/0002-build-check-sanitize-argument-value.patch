From: =?UTF-8?q?Sven=20P=C3=BCschel?= <s.pueschel@pengutronix.de>
Date: Tue, 28 Oct 2025 12:11:36 +0100
Subject: [PATCH] build: check sanitize argument value
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Check the value of the sanitize argument to determine if sanitize
should be enabled. This fixes that sanitize is enabled when
--disable-sanitize is passed to the configure script.

The third AC_ARG_ENABLE parameter defines an action, if the parameter is
present, but doesn't check it's value. Therefore it is also invoked if
the parameter is disabled or --enable-foo=no is set. Therefore don't
define these actions and instead check the value with an AS_IF statement
afterwards, as shown in [1].

[1] https://autotools.info/autoconf/arguments.html

Fixes: 257800a03c6b ("build: Add support for sanitizer compiler flags")

Upstream-Status: Submitted [https://gitlab.freedesktop.org/libbsd/libbsd/-/merge_requests/31]

Signed-off-by: Sven PÃ¼schel <s.pueschel@pengutronix.de>
---
 configure.ac | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/configure.ac b/configure.ac
index 2a15d720f9db..c3fed26939a4 100644
--- a/configure.ac
+++ b/configure.ac
@@ -425,7 +425,8 @@ AS_IF([test "$user_CFLAGS" = unset], [
   CFLAGS="$CFLAGS $LIBBSD_COMPILER_FLAGS"
 
   AC_ARG_ENABLE([sanitize],
-    [AS_HELP_STRING([--enable-sanitize], [enable compiler sanitizer support])],
+    [AS_HELP_STRING([--enable-sanitize], [enable compiler sanitizer support])])
+  AS_IF([test "x$enable_sanitize" = "xyes"],
   [
     LIBBSD_COMPILER_FLAGS=''
     LIBBSD_CHECK_COMPILER_FLAG([-fsanitize=address])
