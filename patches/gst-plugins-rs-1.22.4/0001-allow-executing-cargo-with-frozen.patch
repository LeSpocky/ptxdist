From: Michael Olbrich <m.olbrich@pengutronix.de>
Date: Tue, 25 Apr 2023 17:43:16 +0200
Subject: [PATCH] allow executing cargo with --frozen

Signed-off-by: Michael Olbrich <m.olbrich@pengutronix.de>
---
 cargo_wrapper.py  | 4 ++++
 meson.build       | 4 ++++
 meson_options.txt | 2 ++
 3 files changed, 10 insertions(+)

diff --git a/cargo_wrapper.py b/cargo_wrapper.py
index c13a7b05e943..80960dc167ce 100644
--- a/cargo_wrapper.py
+++ b/cargo_wrapper.py
@@ -27,6 +27,7 @@ PARSER.add_argument('--lib-suffixes', nargs="+", default=[])
 PARSER.add_argument('--exe-suffix')
 PARSER.add_argument('--depfile')
 PARSER.add_argument('--disable-doc', action="store_true", default=False)
+PARSER.add_argument('--frozen', action="store_true", default=False)
 
 
 def generate_depfile_for(fpath):
@@ -110,6 +111,9 @@ if __name__ == "__main__":
         print("Unknown command:", opts.command, file=logfile)
         sys.exit(1)
 
+    if opts.frozen:
+        cargo_cmd += ['--frozen']
+
     if rustc_target:
         cargo_cmd += ['--target', rustc_target]
     if features:
diff --git a/meson.build b/meson.build
index dfe2583870df..5b36281a9c83 100644
--- a/meson.build
+++ b/meson.build
@@ -367,6 +367,10 @@ if get_option('doc').disabled()
   extra_args += ['--disable-doc']
 endif
 
+if get_option('frozen')
+  extra_args += ['--frozen']
+endif
+
 # 'pkgconfig' is the entry in the machine file, if specified
 pkg_config = find_program('pkgconfig', required: false)
 if pkg_config.found()
diff --git a/meson_options.txt b/meson_options.txt
index 033e586c6ed6..549e0167bfc0 100644
--- a/meson_options.txt
+++ b/meson_options.txt
@@ -62,3 +62,5 @@ option('doc', type: 'feature', value: 'auto', yield: true,
        description: 'Enable documentation')
 option('examples', type: 'feature', value: 'disabled', yield: true,
        description: 'Build examples')
+option('frozen', type: 'boolean', value: false,
+       description: 'Run cargo with --frozen')
